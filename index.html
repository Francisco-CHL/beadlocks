<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beadlock - Orden de apriete en estrella</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Serif+Display&display=swap");

    :root {
      --ink: #111827;
      --muted: #5b6475;
      --panel: #ffffff;
      --line: #d7dee8;
      --accent: #0ea5a4;
      --accent-strong: #0f766e;
      --accent-soft: #d7f5f2;
      --done: #a8b2bf;
      --shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Avenir Next", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 10% 10%, #e9fbf8 0%, transparent 35%),
        radial-gradient(circle at 90% 0%, #eef2ff 0%, transparent 35%),
        linear-gradient(160deg, #f8fafc 0%, #eef2f7 100%);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1240px;
      margin: 0 auto;
      padding: 28px 20px 40px;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }

    .hero h1 {
      margin: 0;
      font-family: "DM Serif Display", "Garamond", serif;
      font-size: clamp(1.6rem, 2.4vw, 2.6rem);
      letter-spacing: 0.2px;
    }

    .hero p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 1rem;
    }

    .hero .tag {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-radius: 999px;
      padding: 6px 14px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(280px, 1.1fr) minmax(280px, 0.9fr);
      gap: 22px;
      align-items: start;
      min-width: 0;
    }

    .card {
      background: var(--panel);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 18px;
      min-width: 0;
      border: 1px solid rgba(15, 23, 42, 0.05);
    }

    .diagram-card {
      display: grid;
      gap: 14px;
      justify-items: center;
    }

    #diagram {
      width: 100%;
      max-width: 660px;
      height: auto;
      display: block;
    }

    .legend {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .legend-arrow {
      width: 34px;
      height: 12px;
      display: inline-block;
    }

    .legend-arrow line {
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .legend-arrow.next line {
      stroke: var(--accent-strong);
      stroke-width: 3;
    }

    .legend-arrow.prev line {
      stroke: #94a3b8;
      stroke-width: 2;
      stroke-dasharray: 6 6;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      border: 2px solid #0f766e;
      background: #d7f5f2;
    }

    .legend-dot.current {
      border-width: 3px;
      background: #fde68a;
      border-color: #b45309;
    }

    .legend-dot.done {
      opacity: 0.5;
    }

    .side {
      display: grid;
      gap: 18px;
    }

    .config h2 {
      margin: 0 0 14px;
      font-size: 1.1rem;
    }

    form {
      display: grid;
      gap: 12px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
    }

    input,
    select {
      border-radius: 12px;
      border: 1px solid var(--line);
      padding: 10px 12px;
      font-family: inherit;
      font-size: 0.95rem;
      background: #f8fafc;
      color: var(--ink);
    }

    input:focus,
    select:focus {
      outline: 2px solid var(--accent-soft);
      border-color: var(--accent);
    }

    .inline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .stage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
    }

    .hint {
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.3;
    }

    .panel {
      display: grid;
      gap: 14px;
    }

    .diagram-card .panel {
      width: min(620px, 100%);
      background: #f8fafc;
      border: 1px solid var(--line);
      box-shadow: none;
    }

    #metaLine {
      color: var(--muted);
      font-size: 0.95rem;
    }

    #stepLabel {
      font-size: 1.05rem;
      font-weight: 600;
    }

    #stageBadges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .stage-badge {
      padding: 6px 10px;
      border-radius: 999px;
      background: #f1f5f9;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.85rem;
    }

    .stage-badge.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border: 1px solid #8ce0d8;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .fab {
      position: fixed;
      right: calc(16px + env(safe-area-inset-right));
      bottom: calc(16px + env(safe-area-inset-bottom));
      z-index: 30;
      display: none;
      border: none;
      border-radius: 999px;
      padding: 12px 18px;
      background: var(--accent);
      color: #fff;
      font-family: inherit;
      font-weight: 700;
      letter-spacing: 0.2px;
      cursor: pointer;
      box-shadow: 0 16px 32px rgba(14, 116, 144, 0.25);
    }

    .fab:active {
      transform: translateY(1px);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      background: var(--accent-strong);
      color: #fff;
      font-family: inherit;
      font-weight: 600;
      letter-spacing: 0.2px;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      box-shadow: 0 8px 18px rgba(14, 116, 144, 0.2);
    }

    button.secondary {
      background: #1f2937;
    }

    button.ghost {
      background: #ffffff;
      color: var(--accent-strong);
      border: 1px solid #99e2dc;
      box-shadow: none;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(14, 116, 144, 0.25);
    }

    button:active {
      transform: translateY(0);
    }

    #autoBtn::after {
      content: " OFF";
      font-weight: 700;
      font-size: 0.85rem;
      margin-left: 6px;
      color: #d7f5f2;
    }

    #autoBtn[data-playing="true"]::after {
      content: " ON";
    }

    .list-title {
      font-weight: 700;
      margin-bottom: 10px;
    }

    .sequence-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 6px;
      max-height: 420px;
      overflow-y: auto;
    }

    .sequence-list li {
      background: #f8fafc;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 0.92rem;
      display: flex;
      gap: 8px;
      align-items: baseline;
      border: 1px solid transparent;
    }

    .sequence-list li .step {
      font-weight: 700;
      color: var(--accent-strong);
      min-width: 72px;
    }

    .sequence-list li.active {
      background: var(--accent-soft);
      border-color: #a4ede6;
    }

    .sequence-list li.done {
      opacity: 0.55;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .wrap {
        padding-bottom: 110px;
      }

      .fab {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .sequence-list {
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div>
        <h1>Beadlock - Orden de apriete en estrella</h1>
        <p>Configura pernos, etapas de torque y sentido antes de comenzar.</p>
      </div>
      <span class="tag">Utilidad online sin login</span>
    </header>

    <main class="layout">
      <section class="card diagram-card">
        <svg id="diagram" viewBox="0 0 600 600" role="img" aria-label="Diagrama beadlock">
          <style>
            svg {
              font-family: "Space Grotesk", "Avenir Next", sans-serif;
            }
            .ring {
              fill: none;
              stroke: #1f2937;
              stroke-width: 6;
            }
            .ring-inner {
              fill: none;
              stroke: #94a3b8;
              stroke-width: 2;
              stroke-dasharray: 6 6;
              opacity: 0.7;
            }
            .bolt circle {
              fill: #e2e8f0;
              stroke: #0f766e;
              stroke-width: 2;
            }
            .bolt text {
              fill: #0f172a;
              font-size: 14px;
              font-weight: 700;
            }
            .bolt.done {
              opacity: 0.4;
            }
            .bolt.current {
              opacity: 1;
            }
            .bolt.current circle {
              stroke-width: 5;
              fill: #fde68a;
              stroke: #b45309;
            }
            .bolt.current text {
              fill: #7c2d12;
              font-weight: 800;
            }
            .arrow {
              fill: none;
              stroke: #0f766e;
              stroke-width: 3;
              stroke-linecap: round;
              stroke-linejoin: round;
              opacity: 0.85;
              pointer-events: none;
            }
            .arrow-prev {
              stroke: #94a3b8;
              stroke-width: 2;
              stroke-dasharray: 6 6;
              opacity: 0.7;
            }
          </style>
          <defs>
            <marker id="arrowHeadSolid" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="#0f766e"></path>
            </marker>
            <marker id="arrowHeadGhost" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="none" stroke="#94a3b8" stroke-width="1.6"></path>
            </marker>
          </defs>
          <circle id="ringOuter" class="ring" cx="300" cy="300" r="210"></circle>
          <circle id="ringInner" class="ring-inner" cx="300" cy="300" r="165"></circle>
          <g id="arrows">
            <line id="arrowPrev" class="arrow arrow-prev" visibility="hidden" marker-end="url(#arrowHeadGhost)"></line>
            <line id="arrowNext" class="arrow" visibility="hidden" marker-end="url(#arrowHeadSolid)"></line>
          </g>
          <g id="bolts"></g>
        </svg>

        <div class="legend">
          <span class="legend-item"><span class="legend-dot current"></span>Actual</span>
          <span class="legend-item"><span class="legend-dot done"></span>Hecho</span>
          <span class="legend-item">
            <svg class="legend-arrow next" viewBox="0 0 34 12" aria-hidden="true">
              <line x1="2" y1="6" x2="30" y2="6"></line>
              <path d="M 26 2 L 32 6 L 26 10" fill="none" stroke="#0f766e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            Siguiente
          </span>
          <span class="legend-item">
            <svg class="legend-arrow prev" viewBox="0 0 34 12" aria-hidden="true">
              <line x1="2" y1="6" x2="30" y2="6"></line>
              <path d="M 26 2 L 32 6 L 26 10" fill="none" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            Anterior
          </span>
        </div>

        <div class="card panel">
          <div id="metaLine"></div>
          <div id="stageBadges"></div>
          <div id="stepLabel">Listo para iniciar.</div>
          <div class="controls">
            <button id="nextBtn" type="button">Siguiente</button>
            <button id="resetBtn" class="secondary" type="button">Reiniciar</button>
            <button id="autoBtn" type="button" data-playing="false" aria-pressed="false">Auto</button>
            <button id="pngBtn" class="ghost" type="button">Descargar PNG</button>
            <button id="svgBtn" class="ghost" type="button">Descargar SVG</button>
          </div>
        </div>
      </section>

      <section class="side">
        <form id="configForm" class="card config">
          <h2>Configuracion</h2>
          <div class="field">
            <label for="boltCount">Cantidad de pernos</label>
            <input id="boltCount" type="number" min="4" step="1" value="32" />
            <span class="hint" id="patternNote"></span>
          </div>
          <div class="field">
            <label>Etapas de torque (3 pasadas)</label>
            <div class="stage-grid">
              <input id="stage1" type="number" step="0.1" placeholder="Etapa 1" value="10" />
              <input id="stage2" type="number" step="0.1" placeholder="Etapa 2" value="18" />
              <input id="stage3" type="number" step="0.1" placeholder="Etapa 3" value="25" />
            </div>
          </div>
          <div class="inline">
            <div class="field">
              <label for="unit">Unidad</label>
              <select id="unit">
                <option value="Nm" selected>Nm</option>
                <option value="lb-ft">lb-ft</option>
              </select>
            </div>
            <div class="field">
              <label for="direction">Sentido</label>
              <select id="direction">
                <option value="apriete" selected>Apriete</option>
                <option value="desapriete">Desapriete</option>
              </select>
            </div>
          </div>
          <button class="ghost" type="submit">Aplicar cambios</button>
          <span class="hint">El patron se genera en estrella para cualquier N. Para 32 pernos coincide con el orden clasico.</span>
        </form>

        <div class="card sequence-card">
          <div class="list-title">Secuencia completa</div>
          <ol id="sequenceList" class="sequence-list"></ol>
        </div>
      </section>
    </main>
  </div>

  <button id="fabNextBtn" class="fab" type="button" aria-label="Siguiente paso">Siguiente</button>

  <script>
    const SVG_NS = "http://www.w3.org/2000/svg";

    const svg = document.getElementById("diagram");
    const boltsGroup = document.getElementById("bolts");
    const ringOuter = document.getElementById("ringOuter");
    const ringInner = document.getElementById("ringInner");
    const arrowPrev = document.getElementById("arrowPrev");
    const arrowNext = document.getElementById("arrowNext");

    const metaLine = document.getElementById("metaLine");
    const stageBadges = document.getElementById("stageBadges");
    const stepLabel = document.getElementById("stepLabel");
    const sequenceList = document.getElementById("sequenceList");
    const patternNote = document.getElementById("patternNote");

    const configForm = document.getElementById("configForm");
    const boltCountInput = document.getElementById("boltCount");
    const stageInputs = [
      document.getElementById("stage1"),
      document.getElementById("stage2"),
      document.getElementById("stage3")
    ];
    const unitSelect = document.getElementById("unit");
    const directionSelect = document.getElementById("direction");

    const nextBtn = document.getElementById("nextBtn");
    const resetBtn = document.getElementById("resetBtn");
    const autoBtn = document.getElementById("autoBtn");
    const pngBtn = document.getElementById("pngBtn");
    const svgBtn = document.getElementById("svgBtn");
    const fabNextBtn = document.getElementById("fabNextBtn");

    const size = 600;
    const cx = size / 2;
    const cy = size / 2;
    const ringRadius = 210;
    const innerRadius = 165;
    const boltRadius = 12;
    const labelRadius = 245;

    const state = {
      boltCount: 32,
      stages: [10, 18, 25],
      unit: "Nm",
      direction: "apriete",
      sequence: [],
      stepIndex: 0,
      stageIndex: 0,
      timer: null
    };

    const boltMap = new Map();
    const boltPositions = new Map();
    const listItems = [];

    function interleave(sequence) {
      // Recursive even-odd shuffle (bit-reversal order) for a balanced star pattern.
      if (sequence.length <= 1) return sequence;
      const evens = sequence.filter((_, index) => index % 2 === 0);
      const odds = sequence.filter((_, index) => index % 2 === 1);
      return interleave(evens).concat(interleave(odds));
    }

    function buildSequence(count, direction) {
      const base = Array.from({ length: count }, (_, i) => i + 1);
      const ordered = interleave(base);
      return direction === "desapriete" ? ordered.slice().reverse() : ordered;
    }

    function sanitizeBoltCount(value) {
      const parsed = Number(value);
      if (!Number.isFinite(parsed)) return 32;
      return Math.max(4, Math.round(parsed));
    }

    function parseStages() {
      const values = stageInputs
        .map((input) => Number(input.value))
        .filter((value) => Number.isFinite(value) && value > 0);
      if (values.length) return values;
      stageInputs[0].value = "25";
      stageInputs[1].value = "";
      stageInputs[2].value = "";
      return [25];
    }

    function shortenLine(ax, ay, bx, by, insetStart, insetEnd) {
      const dx = bx - ax;
      const dy = by - ay;
      const dist = Math.hypot(dx, dy);
      if (dist === 0) {
        return { x1: ax, y1: ay, x2: bx, y2: by };
      }
      const ux = dx / dist;
      const uy = dy / dist;
      return {
        x1: ax + ux * insetStart,
        y1: ay + uy * insetStart,
        x2: bx - ux * insetEnd,
        y2: by - uy * insetEnd
      };
    }

    function setArrow(arrow, fromNumber, toNumber) {
      if (!fromNumber || !toNumber) {
        arrow.setAttribute("visibility", "hidden");
        return;
      }
      const from = boltPositions.get(fromNumber);
      const to = boltPositions.get(toNumber);
      if (!from || !to) {
        arrow.setAttribute("visibility", "hidden");
        return;
      }
      const inset = boltRadius + 6;
      const line = shortenLine(from.x, from.y, to.x, to.y, inset, inset + 2);
      arrow.setAttribute("x1", line.x1.toFixed(2));
      arrow.setAttribute("y1", line.y1.toFixed(2));
      arrow.setAttribute("x2", line.x2.toFixed(2));
      arrow.setAttribute("y2", line.y2.toFixed(2));
      arrow.setAttribute("visibility", "visible");
    }

    function buildDiagram() {
      boltsGroup.innerHTML = "";
      boltMap.clear();
      boltPositions.clear();

      svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
      ringOuter.setAttribute("cx", cx);
      ringOuter.setAttribute("cy", cy);
      ringOuter.setAttribute("r", ringRadius);
      ringInner.setAttribute("cx", cx);
      ringInner.setAttribute("cy", cy);
      ringInner.setAttribute("r", innerRadius);

      for (let i = 0; i < state.boltCount; i += 1) {
        const number = i + 1;

        // Angle formula: start at -90deg and move clockwise in equal steps.
        const angle = (-Math.PI / 2) + i * (2 * Math.PI / state.boltCount);
        const x = cx + ringRadius * Math.cos(angle);
        const y = cy + ringRadius * Math.sin(angle);
        const lx = cx + labelRadius * Math.cos(angle);
        const ly = cy + labelRadius * Math.sin(angle);

        const group = document.createElementNS(SVG_NS, "g");
        group.classList.add("bolt");
        group.dataset.number = number;

        const circle = document.createElementNS(SVG_NS, "circle");
        circle.setAttribute("cx", x.toFixed(2));
        circle.setAttribute("cy", y.toFixed(2));
        circle.setAttribute("r", boltRadius);

        const text = document.createElementNS(SVG_NS, "text");
        text.setAttribute("x", lx.toFixed(2));
        text.setAttribute("y", ly.toFixed(2));
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.textContent = number;

        group.appendChild(circle);
        group.appendChild(text);
        boltsGroup.appendChild(group);
        boltMap.set(number, group);
        boltPositions.set(number, { x, y });
      }
    }

    function buildSequenceList() {
      sequenceList.innerHTML = "";
      listItems.length = 0;

      state.sequence.forEach((number, index) => {
        const li = document.createElement("li");
        li.dataset.step = index + 1;
        li.innerHTML = `<span class="step">Paso ${index + 1}:</span> perno ${number}`;
        sequenceList.appendChild(li);
        listItems[index + 1] = li;
      });
    }

    function renderStageBadges() {
      stageBadges.innerHTML = "";
      state.stages.forEach((value, index) => {
        const badge = document.createElement("span");
        badge.className = "stage-badge" + (index === state.stageIndex ? " active" : "");
        badge.textContent = `Etapa ${index + 1}: ${value} ${state.unit}`;
        stageBadges.appendChild(badge);
      });
    }

    function render() {
      const currentNumber = state.stepIndex === 0 ? null : state.sequence[state.stepIndex - 1];
      const doneSet = new Set(state.sequence.slice(0, Math.max(0, state.stepIndex - 1)));
      const verb = state.direction === "desapriete" ? "afloja" : "aprieta";
      const prevNumber = currentNumber && state.stepIndex > 1 ? state.sequence[state.stepIndex - 2] : null;
      const nextNumber = currentNumber && state.stepIndex < state.boltCount
        ? state.sequence[state.stepIndex]
        : null;

      for (let number = 1; number <= state.boltCount; number += 1) {
        const bolt = boltMap.get(number);
        if (!bolt) continue;
        bolt.classList.toggle("current", number === currentNumber);
        bolt.classList.toggle("done", doneSet.has(number));
      }

      for (let step = 1; step <= state.boltCount; step += 1) {
        const item = listItems[step];
        if (!item) continue;
        item.classList.toggle("active", step === state.stepIndex);
        item.classList.toggle("done", step < state.stepIndex);
      }

      setArrow(arrowPrev, prevNumber, currentNumber);
      setArrow(arrowNext, currentNumber, nextNumber);

      const stageValue = state.stages[state.stageIndex];
      const stageText = `Etapa ${state.stageIndex + 1}/${state.stages.length} - ${stageValue} ${state.unit}`;

      if (state.stepIndex === 0) {
        stepLabel.textContent = `${stageText} - listo para iniciar`;
      } else if (state.stepIndex <= state.boltCount) {
        stepLabel.textContent = `${stageText} - Paso ${state.stepIndex}/${state.boltCount}: ${verb} perno ${currentNumber}`;
      } else {
        stepLabel.textContent = `${stageText} - etapa completada`;
      }

      metaLine.textContent = `Pernos: ${state.boltCount} | Sentido: ${state.direction} | Patron en estrella`;
      renderStageBadges();
    }

    function isDone() {
      return state.stageIndex === state.stages.length - 1 && state.stepIndex >= state.boltCount;
    }

    function nextStep() {
      if (isDone()) {
        stopAuto();
        return;
      }

      if (state.stepIndex < state.boltCount) {
        state.stepIndex += 1;
        render();
        return;
      }

      if (state.stageIndex < state.stages.length - 1) {
        state.stageIndex += 1;
        state.stepIndex = 0;
        render();
        return;
      }

      stopAuto();
    }

    function resetSteps() {
      state.stepIndex = 0;
      state.stageIndex = 0;
      render();
      stopAuto();
    }

    function startAuto() {
      if (state.timer) return;
      state.timer = setInterval(() => {
        nextStep();
      }, 600);
      updateAutoButton(true);
    }

    function stopAuto() {
      if (!state.timer) {
        updateAutoButton(false);
        return;
      }
      clearInterval(state.timer);
      state.timer = null;
      updateAutoButton(false);
    }

    function toggleAuto() {
      if (state.timer) {
        stopAuto();
      } else {
        startAuto();
      }
    }

    function updateAutoButton(isPlaying) {
      autoBtn.dataset.playing = isPlaying ? "true" : "false";
      autoBtn.setAttribute("aria-pressed", isPlaying ? "true" : "false");
    }

    function serializeSvg() {
      const clone = svg.cloneNode(true);
      clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      clone.setAttribute("width", size);
      clone.setAttribute("height", size);
      return new XMLSerializer().serializeToString(clone);
    }

    function downloadSvg() {
      const svgString = serializeSvg();
      const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "beadlock-orden.svg";
      document.body.appendChild(link);
      link.click();
      link.remove();

      URL.revokeObjectURL(url);
    }

    function downloadPng() {
      const svgString = serializeSvg();
      const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const img = new Image();

      img.onload = () => {
        const vb = svg.viewBox.baseVal;
        const exportSize = 1600;
        const scale = exportSize / vb.width;

        const canvas = document.createElement("canvas");
        canvas.width = vb.width * scale;
        canvas.height = vb.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        canvas.toBlob((pngBlob) => {
          const pngUrl = URL.createObjectURL(pngBlob);
          const link = document.createElement("a");
          link.href = pngUrl;
          link.download = "beadlock-orden.png";
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(pngUrl);
        }, "image/png");

        URL.revokeObjectURL(url);
      };

      img.onerror = () => {
        URL.revokeObjectURL(url);
      };

      img.src = url;
    }

    function applyConfig() {
      const nextCount = sanitizeBoltCount(boltCountInput.value);
      const stages = parseStages();
      state.boltCount = nextCount;
      state.stages = stages;
      state.unit = unitSelect.value;
      state.direction = directionSelect.value;
      state.sequence = buildSequence(state.boltCount, state.direction);
      state.stepIndex = 0;
      state.stageIndex = 0;

      boltCountInput.value = nextCount;
      patternNote.textContent = nextCount % 2 === 0
        ? ""
        : "Nota: N impar usa un patron equilibrado (no hay pernos opuestos exactos).";

      buildDiagram();
      buildSequenceList();
      render();
      stopAuto();
    }

    configForm.addEventListener("submit", (event) => {
      event.preventDefault();
      applyConfig();
    });

    nextBtn.addEventListener("click", nextStep);
    fabNextBtn.addEventListener("click", nextStep);
    resetBtn.addEventListener("click", resetSteps);
    autoBtn.addEventListener("click", toggleAuto);
    svgBtn.addEventListener("click", downloadSvg);
    pngBtn.addEventListener("click", downloadPng);

    applyConfig();
  </script>
</body>
</html>
